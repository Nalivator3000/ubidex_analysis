services:
  # PostgreSQL для метаданных Superset и данных приложения
  postgres:
    image: postgres:15
    container_name: ubidex_postgres
    environment:
      POSTGRES_USER: ubidex
      POSTGRES_PASSWORD: ubidex
      POSTGRES_DB: ubidex
      # Создать дополнительные базы данных
      POSTGRES_MULTIPLE_DATABASES: superset
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ubidex"]
      interval: 10s
      timeout: 5s
      retries: 5
    # Оптимизация для больших данных
    command: >
      postgres
      -c shared_buffers=256MB
      -c effective_cache_size=1GB
      -c maintenance_work_mem=128MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=16MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB

  # Redis для кеширования Superset
  redis:
    image: redis:7-alpine
    container_name: ubidex_redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Superset
  superset:
    image: apache/superset:latest
    container_name: ubidex_superset
    user: root
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      SUPERSET_CONFIG_PATH: /app/superset_config.py
      SUPERSET_SECRET_KEY: 'your-secret-key-change-in-production'
      DATABASE_URL: postgresql://ubidex:ubidex@postgres:5432/superset
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # PostgreSQL connection for data
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ubidex
      POSTGRES_PASSWORD: ubidex
      POSTGRES_DB: ubidex
    volumes:
      - ./superset_config.py:/app/superset_config.py:ro
      - ./superset_init.py:/app/superset_init.py:ro
      - ./superset-entrypoint.sh:/app/superset-entrypoint.sh:ro
      - ./data:/data:ro
      - superset_data:/app/superset_home
    ports:
      - "8088:8088"
    entrypoint: ["/bin/bash", "/app/superset-entrypoint.sh"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Приложение анализа
  analysis:
    build: .
    container_name: ubidex_analysis
    volumes:
      - ./07_scripts:/app/scripts:ro
      - ./superset_queries:/app/superset_queries:ro
      - ./data:/data:rw
      - ./output:/app/output:rw
    environment:
      - PYTHONUNBUFFERED=1
      # PostgreSQL connection
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_USER=ubidex
      - POSTGRES_PASSWORD=ubidex
      - POSTGRES_DB=ubidex
      # Для обратной совместимости (если нужно)
      - DB_TYPE=postgresql
    command: tail -f /dev/null  # Keep container running
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data:
  superset_data:

