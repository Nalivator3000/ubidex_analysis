# Подробная инструкция: Создание Chart и Dashboard с фильтром по дате реактивации

Это пошаговое руководство поможет создать Chart для анализа реактиваций с возможностью фильтрации по дате прямо в Dashboard.

## Шаг 1: Создание Dataset

### 1.1. Выполнение SQL-запроса

1. Откройте Superset: **http://localhost:8088**
2. Войдите (логин: `admin`, пароль: `admin`)
3. В верхнем меню перейдите в **SQL** → **SQL Lab**
4. Выберите базу данных: **"Ubidex Events DB"**
5. Откройте файл `reactivations_summary_by_period_simple.sql`
6. Скопируйте весь SQL-запрос и вставьте в редактор SQL Lab
7. Нажмите кнопку **"Run"** (синяя кнопка справа)
8. Дождитесь выполнения запроса (должно быть быстро, ~0.2 секунды)

### 1.2. Сохранение как Dataset

1. После выполнения запроса нажмите кнопку **"Save"** (вверху справа, рядом с "Run")
2. В выпадающем меню выберите **"Save as dataset"**
3. В открывшемся окне:
   - **Table name**: `Реактивации` (или `Reactivations`)
   - **Schema**: `public` (должно быть выбрано автоматически)
   - **Database**: `Ubidex Events DB` (должно быть выбрано автоматически)
4. Нажмите **"Save"**

### 1.3. Настройка типов колонок в Dataset

1. После создания Dataset вы будете перенаправлены на страницу Dataset
2. Проверьте типы колонок:
   - **`first_deposit`** должен иметь тип **"Temporal"** или **"Date/Time"**
     - Если тип другой, нажмите на колонку → выберите **"Temporal"** или **"Date/Time"**
   - **`inactivity_period`** должен быть **"String"** или **"Text"**
   - **`user_id`** должен быть **"String"** или **"Text"**
   - **`days_inactive`** должен быть **"Numeric"** или **"Float"**
3. Нажмите **"SAVE"** (вверху справа)

---

## Шаг 2: Создание Chart

### 2.1. Создание нового Chart

1. В верхнем меню перейдите в **Data** → **Charts**
2. Нажмите синюю кнопку **"+ CHART"**
3. В открывшемся окне:
   - **Dataset**: Выберите **"Реактивации"** (созданный Dataset)
   - Нажмите **"CREATE NEW CHART"**

### 2.2. Настройка визуализации

Вы окажетесь в **Chart Builder**. Настройте Chart:

#### Для Bar Chart (график):

1. **Visualization type**: Выберите **"Bar Chart"** (иконка столбцов)
2. В правой панели в разделе **"Query"**:
   - **Query mode**: Выберите **"Aggregate"** (не "Raw records")
   - **Group by**: 
     - Нажмите **"+ Add"** или перетащите колонку `inactivity_period` из левой панели
     - Выберите `inactivity_period`
   - **Metrics**:
     - Нажмите **"+ Add"** или перетащите `user_id` из левой панели
     - Выберите функцию: **"COUNT DISTINCT"** или **"COUNT"**
     - Или создайте метрику: нажмите **"+ Add metric"** → **"COUNT(user_id)"**
3. Нажмите **"Run"** (вверху справа) для предпросмотра
4. Вы должны увидеть график с периодами неактивности (7-14 days, 14-30 days, и т.д.)

#### Для Table (таблица):

1. **Visualization type**: Выберите **"Table"** (иконка таблицы)
2. В правой панели в разделе **"Query"**:
   - **Query mode**: Выберите **"Aggregate"**
   - **Group by**: `inactivity_period`
   - **Metrics**:
     - `COUNT(user_id)` - количество реактиваций
     - `AVG(days_inactive)` - средние дни неактивности
     - Добавьте другие метрики по необходимости
3. Нажмите **"Run"** для предпросмотра

### 2.3. Сохранение Chart

1. После настройки нажмите **"SAVE"** (вверху справа)
2. В открывшемся окне:
   - **Chart name**: `Реактивации по периодам` (или другое название)
   - **Description** (опционально): "Анализ реактиваций пользователей по периодам неактивности"
   - **Add to new dashboard**: 
     - Выберите **"Add to new dashboard"**
     - **Dashboard name**: `Анализ реактиваций`
   - Или **Add to existing dashboard**: Выберите существующий Dashboard
3. Нажмите **"SAVE & GO TO DASHBOARD"**

---

## Шаг 3: Добавление фильтра по дате на Dashboard

### 3.1. Редактирование Dashboard

1. Вы будете перенаправлены на Dashboard
2. Нажмите кнопку **"Edit dashboard"** (вверху справа, иконка карандаша)

### 3.2. Создание Date Range Filter

1. На Dashboard нажмите кнопку **"+ ADD FILTER"** (обычно вверху или слева)
2. В выпадающем списке выберите **"Date Range Filter"**
3. В открывшемся окне настройте фильтр:

   **Основные настройки:**
   - **Filter name**: `Период реактивации` (или другое название)
   - **Dataset**: Выберите **"Реактивации"** (ваш Dataset)
   - **Time column**: Выберите **`first_deposit`** ← **ВАЖНО: это дата реактивации!**
   - **Default value**: 
     - Выберите **"Custom..."** для установки диапазона по умолчанию
     - Или выберите **"Last 30 days"**, **"Last 7 days"** и т.д.
     - Или оставьте пустым (пользователь выберет сам)

   **Дополнительные настройки (опционально):**
   - **Filter description**: "Выберите период для анализа реактиваций"
   - **Required**: Оставьте выключенным (чтобы фильтр был опциональным)

4. Нажмите **"SAVE"**

### 3.3. Настройка Scoping (связывание фильтра с Chart)

1. После создания фильтра вы увидите его на Dashboard в режиме редактирования
2. Нажмите на созданный фильтр (на его заголовок или область)
3. В открывшемся окне найдите раздел **"Scoping"** или **"Chart scoping"**
4. В списке Charts выберите ваш Chart: **"Реактивации по периодам"**
   - Убедитесь, что галочка стоит напротив вашего Chart
   - Если есть другие Charts, которые не должны фильтроваться, снимите с них галочки
5. Нажмите **"SAVE"**

### 3.4. Расположение элементов на Dashboard

1. Перетащите фильтр в удобное место (обычно вверху Dashboard)
2. Перетащите Chart в нужное место
3. Измените размер Chart, потянув за углы
4. Нажмите **"SAVE"** (вверху справа) для сохранения Dashboard

---

## Шаг 4: Проверка работы фильтра

### 4.1. Тестирование фильтра

1. Выйдите из режима редактирования (нажмите **"Edit dashboard"** еще раз или закройте режим редактирования)
2. В фильтре **"Период реактивации"**:
   - Нажмите на поле даты
   - Выберите **"Custom range"** или используйте предустановленные значения
   - Установите даты, например:
     - **Start date**: `2025-08-23`
     - **End date**: `2025-08-25`
3. Нажмите **"Apply"** или просто выберите даты (фильтр применится автоматически)
4. Chart должен автоматически обновиться и показать данные только за выбранный период

### 4.2. Что вы должны увидеть

После применения фильтра Chart покажет:
- **7-14 days**: X реактиваций за выбранный период
- **14-30 days**: Y реактиваций за выбранный период
- **30-90 days**: Z реактиваций за выбранный период
- **90+ days**: W реактиваций за выбранный период

Все данные будут отфильтрованы по дате реактивации (`first_deposit`), которую вы выбрали в фильтре.

---

## Шаг 5: Дополнительные настройки (опционально)

### 5.1. Добавление дополнительных метрик в Chart

1. Откройте Chart для редактирования
2. В разделе **"Metrics"** добавьте:
   - `AVG(days_inactive)` - средние дни неактивности
   - `MIN(days_inactive)` - минимальные дни неактивности
   - `MAX(days_inactive)` - максимальные дни неактивности
3. Сохраните Chart

### 5.2. Добавление дополнительных Charts

Можно создать несколько Charts для разных визуализаций:
- **Pie Chart** - для распределения по периодам
- **Time Series Chart** - для динамики реактиваций по времени
- **Table** - для детальной таблицы

Все Charts можно связать с одним фильтром через Scoping.

### 5.3. Настройка внешнего вида Dashboard

1. В режиме редактирования Dashboard:
   - Измените размеры Charts
   - Переместите элементы
   - Добавьте текст или заголовки (если поддерживается)
2. Сохраните Dashboard

---

## Решение проблем

### Проблема: Фильтр не применяется к Chart

**Решение:**
1. Проверьте Scoping: откройте фильтр → раздел Scoping → убедитесь, что Chart выбран
2. Убедитесь, что Chart использует правильный Dataset (тот же, что и фильтр)
3. Перезагрузите страницу Dashboard

### Проблема: Chart показывает "No data"

**Решение:**
1. Проверьте, что фильтр применяется правильно
2. Убедитесь, что в выбранном периоде есть данные
3. Попробуйте расширить диапазон дат в фильтре

### Проблема: Данные не обновляются при изменении фильтра

**Решение:**
1. Проверьте Scoping фильтра
2. Убедитесь, что Chart использует режим "Aggregate"
3. Попробуйте обновить страницу

---

## Готово!

Теперь у вас есть Dashboard с Chart, который показывает реактивации по периодам неактивности, и фильтр по дате, который позволяет выбирать любой период для анализа.

**Для обновления данных** (если добавились новые депозиты):
```bash
docker exec ubidex_postgres psql -U ubidex -d ubidex -c "REFRESH MATERIALIZED VIEW reactivations_materialized;"
```

После обновления представления данные в Chart автоматически обновятся.

