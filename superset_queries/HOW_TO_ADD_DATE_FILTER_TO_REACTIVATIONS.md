# Как добавить фильтр по датам для Chart с реактивациями

Есть два способа добавить возможность выбора дат в интерфейсе Dashboard:

## Способ 1: Использование параметров Superset (РЕКОМЕНДУЕТСЯ)

Этот способ позволяет выбирать даты прямо в интерфейсе Dashboard через фильтры.

### Шаг 1: Создание Chart с параметрами

1. Откройте **SQL Lab** в Superset
2. Выберите базу данных: **"Ubidex Events DB"**
3. Откройте файл `reactivations_summary_by_period_with_filters.sql`
4. Скопируйте SQL-запрос и вставьте в редактор
5. **ВАЖНО**: Нажмите на иконку **шестеренки** (⚙️) справа от редактора - это **"Query Settings"**
6. В открывшемся окне найдите раздел **"Parameters"** или **"Template Parameters"**
7. Добавьте два параметра:
   - **Параметр 1:**
     - Name: `start_date`
     - Type: `Date`
     - Default: `2025-11-01`
   - **Параметр 2:**
     - Name: `end_date`
     - Type: `Date`
     - Default: `2025-11-30`
8. Нажмите **"Run"** для проверки запроса
9. Нажмите **"Explore"** для создания Chart
10. Настройте визуализацию (Bar Chart, Pie Chart или Table)
11. Нажмите **"SAVE"**
12. Сохраните Chart с именем "Реактивации по периодам"

### Шаг 2: Добавление фильтра на Dashboard

1. Откройте Dashboard, где находится ваш Chart
2. Нажмите **"Edit dashboard"**
3. Нажмите **"+ ADD FILTER"**
4. Выберите **"Date Range Filter"**
5. Настройте фильтр:
   - **Filter name**: "Период реактивации"
   - **Dataset**: Выберите Dataset, созданный на основе вашего SQL-запроса
   - **Time column**: `first_deposit` (или `event_date`, если используете Dataset из user_events)
   - **Default value**: Установите нужный диапазон (например, "Last 30 days")
6. Нажмите **"SAVE"**

### Шаг 3: Настройка Scoping (связывание фильтра с Chart)

1. В режиме редактирования Dashboard нажмите на созданный фильтр
2. В разделе **"Scoping"** выберите:
   - **Chart**: "Реактивации по периодам"
3. Убедитесь, что фильтр применяется к Chart
4. Нажмите **"SAVE"**

**Проблема**: Фильтры Dashboard могут не работать напрямую с SQL-запросами, использующими CTE. В этом случае используйте **Способ 2**.

---

## Способ 2: Создание Dataset на основе user_events (АЛЬТЕРНАТИВА)

Этот способ создает Dataset на основе таблицы `user_events`, к которому можно применять фильтры Dashboard.

### Шаг 1: Создание Dataset

1. Откройте **Data** → **Datasets**
2. Нажмите **"+ DATASET"**
3. Выберите базу данных: **"Ubidex Events DB"**
4. Выберите схему: **"public"**
5. Выберите таблицу: **"user_events"**
6. Нажмите **"ADD"**
7. На странице Dataset:
   - Убедитесь, что колонка `event_date` имеет тип `Temporal` (или `Date/Time`)
   - Нажмите **"SAVE"**

### Шаг 2: Создание Chart с использованием Dataset

**ВАЖНО**: Для расчета реактиваций все равно нужен SQL-запрос, так как логика сложная. Но можно создать виртуальную таблицу (SQL View).

1. В **SQL Lab** создайте SQL-запрос из `reactivations_summary_by_period_simple.sql`
2. Выполните запрос
3. Нажмите **"Explore"**
4. При создании Chart выберите Dataset на основе вашего SQL-запроса
5. Сохраните Chart

### Шаг 3: Добавление фильтра

1. На Dashboard добавьте **Date Range Filter**
2. Выберите Dataset на основе `user_events`
3. Выберите колонку `event_date`
4. Настройте Scoping для применения к Chart

**Ограничение**: Фильтры Dashboard могут не работать напрямую с SQL-запросами, использующими CTE. В этом случае лучше использовать параметры (Способ 1).

---

## Способ 3: Использование простого запроса без параметров (САМЫЙ ПРОСТОЙ)

Если фильтры Dashboard не работают с SQL-запросами, можно:

1. Использовать запрос `reactivations_summary_by_period_simple.sql`
2. Для изменения периода просто измените даты в SQL-запросе (строки 24-25)
3. Перезапустите запрос

Это не так удобно, как фильтры, но работает надежно.

---

## Рекомендация

**Используйте Способ 1** (параметры Superset), так как он дает наибольшую гибкость. Если параметры не работают, используйте **Способ 3** (изменение дат в запросе).

Для автоматического обновления Chart при изменении дат в фильтре Dashboard может потребоваться создание виртуальной таблицы (SQL View) или использование специальных настроек Superset.

